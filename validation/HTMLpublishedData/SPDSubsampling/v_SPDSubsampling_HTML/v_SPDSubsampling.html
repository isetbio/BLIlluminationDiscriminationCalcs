
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>v_SPDSubsampling</title><meta name="generator" content="MATLAB 8.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-04-01"><meta name="DC.source" content="v_SPDSubsampling.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Function implementing the isetbio validation code</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> varargout = v_SPDSubsampling(varargin)
<span class="comment">%</span>
<span class="comment">% This function will validate the effects of subsampling the SPD's of the</span>
<span class="comment">% display.</span>
<span class="comment">%</span>
<span class="comment">% 7/30/15  xd  modified from Nicolas's original code to make a validation</span>
<span class="comment">%              script</span>

varargout = UnitTest.runValidationRun(@ValidationFunction, nargout, varargin);
<span class="keyword">end</span>
</pre><h2>Function implementing the isetbio validation code<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> ValidationFunction(runTimeParams)
<span class="comment">% close all figures</span>
close <span class="string">all</span>

<span class="comment">% Load the imageData and generate the calibrationData object</span>
calStructOBJ = loadCalibrationData(<span class="string">'StereoLCDBLIllumDiscrim'</span>);
calStructOBJ.cal.describe;

<span class="comment">% Retrieve the display primaries SPD data from the calibration</span>
wavelengthSampling = SToWls(calStructOBJ.get(<span class="string">'S'</span>));
originalSPDs = calStructOBJ.get(<span class="string">'P_device'</span>);

primaries = {<span class="string">'RED'</span>, <span class="string">'GREEN'</span>, <span class="string">'BLUE'</span>};
coneTypes = {<span class="string">'L'</span>, <span class="string">'M'</span>, <span class="string">'S'</span>};

<span class="comment">% Analysis parameters</span>
<span class="comment">% set this to false to visualize primary SPDs on same scale</span>
<span class="comment">% set this to true to maintain total power constant</span>
maintainTotalEnergy = true;

<span class="comment">% size of FFT</span>
FFTsize = 1024;

<span class="comment">% SPD subsampling factors to examine (1==original SPD)</span>
subSamplingFactorsTested = [1 2 4 6 8 10 12 14 16 18 20];

<span class="keyword">for</span> subSamplingFactorIndex = 1:numel(subSamplingFactorsTested)

    subSamplingFactor = subSamplingFactorsTested(subSamplingFactorIndex);
    subSamplingVector = (1:subSamplingFactor:numel(wavelengthSampling));
    subSampledWavelengthSampling = wavelengthSampling(subSamplingVector);

    <span class="comment">% set the sigma of the gaussian kernel according to subSamplingFactor</span>
    sigma = subSamplingFactor/2;
    <span class="comment">% generate lowpass kernel</span>
    kernelF = generateGaussianLowPassKernel(subSamplingFactor, sigma, wavelengthSampling, maintainTotalEnergy);

    <span class="comment">% zero pad kernel to increase spectral resolution</span>
    ix = floor(numel(kernelF)/2);
    paddedKernelF = zeros(1,FFTsize);
    paddedKernelF(FFTsize/2+(-ix:ix)) = kernelF;

    lowpassedSPD = zeros(numel(wavelengthSampling), numel(primaries));
    subsampledSPD = zeros(numel(subSamplingVector), numel(primaries));

    <span class="keyword">for</span> primaryIndex = 1:numel(primaries)
        <span class="comment">% zero pad SPD to increase spectral resolution</span>
        paddedSPD = zeros(1,FFTsize);
        paddedSPD(FFTsize/2+(-ix:ix)) = squeeze(originalSPDs(:,primaryIndex));

        <span class="comment">% filter SPD with kernel in frequency domain</span>
        FFTkernel = fft(paddedKernelF);
        FFTspd    = fft(paddedSPD);
        tmp       = FFTspd .* FFTkernel;

        <span class="comment">% back in original domain</span>
        tmp = ifftshift(ifft(tmp));
        lowpassedSPD(:,primaryIndex)  = tmp(FFTsize/2-1+(-ix:ix));

        <span class="comment">% subsampled the lowpassed SPD</span>
        subsampledSPD(:,primaryIndex) = lowpassedSPD(subSamplingVector,primaryIndex);
    <span class="keyword">end</span>

    originalSPDpower   = sum(originalSPDs,1);
    subSampledSPDpower = sum(subsampledSPD,1);


    hFig = figure(subSamplingFactor);
    set(hFig, <span class="string">'Position'</span>, [200 200 1731 1064]);
    clf;

    maxY = max([max(subsampledSPD(:)) max(originalSPDs(:)) max(lowpassedSPD(:))]);

    <span class="comment">% plot SPDs (original, lowpassed, and subsampled as well as the smoothing kernel)</span>
    <span class="keyword">for</span> primaryIndex = 1:numel(primaries)
        subplot(3, 7, [1 2 3 4 5 6]+(primaryIndex-1)*7);
        hold <span class="string">on</span>;
        plot(subSampledWavelengthSampling, subsampledSPD(:,primaryIndex), <span class="string">'ro-'</span>, <span class="string">'MarkerFaceColor'</span>, [1.0 0.7 0.7], <span class="string">'MarkerSize'</span>, 14);
        plot(wavelengthSampling, lowpassedSPD(:, primaryIndex), <span class="string">'ks:'</span>, <span class="string">'MarkerFaceColor'</span>, [0.8 0.8 0.8], <span class="string">'MarkerSize'</span>, 8);
        plot(wavelengthSampling, originalSPDs(:, primaryIndex), <span class="string">'ks-'</span>, <span class="string">'MarkerFaceColor'</span>, [0.1 0.1 0.1], <span class="string">'MarkerSize'</span>, 6);
        hStem = stem(wavelengthSampling, maxY/2 + kernelF*maxY/3, <span class="string">'Color'</span>, [0.5 0.5 0.90], <span class="string">'LineWidth'</span>, 1, <span class="string">'MarkerFaceColor'</span>, [0.7 0.7 0.9]);
        hStem.BaseValue = maxY/2;
        hold <span class="string">off</span>;
        set(gca, <span class="string">'YLim'</span>, [0 maxY], <span class="string">'XLim'</span>, [min(wavelengthSampling) max(wavelengthSampling)]);
        h_legend=legend(<span class="string">'subsampled SPD'</span>, <span class="string">'lowpassedSPD'</span>, <span class="string">'originalSPD'</span>, <span class="string">'lowpass kernel'</span>);
        box <span class="string">on</span>;
        xlabel(<span class="string">'wavelength (nm)'</span>); ylabel(<span class="string">'energy'</span>);
        title(sprintf(<span class="string">'%s PRIMARY power = %2.4f (original SPD) vs. %2.4f (subsampled SPD)'</span>, primaries{primaryIndex}, originalSPDpower(primaryIndex), subSampledSPDpower(primaryIndex)));
    <span class="keyword">end</span>

    <span class="comment">% Load cone spectra and interpolate to desired wavelength sampling</span>
    load(<span class="string">'T_cones_ss2.mat'</span>);
    originalSpectralSensitivityFunctions       = SplineCmf(S_cones_ss2, T_cones_ss2, WlsToS(wavelengthSampling));
    subSampledConeSpectralSensitivityFunctions = SplineCmf(S_cones_ss2, T_cones_ss2, WlsToS(subSampledWavelengthSampling));

    <span class="comment">% Compute cone activations</span>
    originalConeExcitation = zeros(3,3);
    subSampledConeExcitation = zeros(3,3);
    <span class="keyword">for</span> cone = 1:3
        <span class="keyword">for</span> primaryIndex = 1:3
            originalConeExcitation(cone, primaryIndex) = sum(originalSpectralSensitivityFunctions(cone,:) .* (originalSPDs(:, primaryIndex))');
            subSampledConeExcitation(cone, primaryIndex) = sum(subSampledConeSpectralSensitivityFunctions(cone,:) .* (subsampledSPD(:, primaryIndex))');
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">% Plot cone activations</span>
    figure(subSamplingFactor);
    <span class="keyword">for</span> primaryIndex = 1:numel(primaries)
        subplot(3, 7, 7+(primaryIndex-1)*7);
        bar([1:3], originalConeExcitation(:,primaryIndex), <span class="string">'EdgeColor'</span>, [0 0 0], <span class="string">'FaceColor'</span>, [0.5 0.5 0.5]);
        hold <span class="string">on</span>;
        bar([1:3], -subSampledConeExcitation(:,primaryIndex), <span class="string">'EdgeColor'</span>, [1 0 0], <span class="string">'FaceColor'</span>, [1.0 0.8 0.8]);
        bar([1:3], originalConeExcitation(:,primaryIndex)-subSampledConeExcitation(:,primaryIndex), <span class="string">'EdgeColor'</span>, [0 1 0], <span class="string">'FaceColor'</span>, [0.1 0.9 0.1]);
        hold <span class="string">off</span>;
        h_legend=legend(<span class="string">'original'</span>, <span class="string">'subsampled'</span>, <span class="string">'residual'</span>);
        xlabel(<span class="string">'cone type'</span>); ylabel(<span class="string">'cone excitation'</span>);
        set(gca, <span class="string">'XTick'</span>, [1 2 3], <span class="string">'XTickLabel'</span>, coneTypes);
        title(sprintf(<span class="string">'%s primary'</span>, primaries{primaryIndex}));
    <span class="keyword">end</span>

    deltas(subSamplingFactorIndex,:,:)       = subSampledConeExcitation;
    excitations(subSamplingFactorIndex, :,:) = originalConeExcitation;

    suplabel([<span class="string">'Subsample Factor: '</span> num2str(subSamplingFactor)], <span class="string">'t'</span>);

    <span class="comment">% Set fonts for all axes, legends, and titles</span>
    NicePlot.setFontSizes(hFig, <span class="string">'FontSize'</span>, 12);
    UnitTest.validationData([<span class="string">'subsamplefactor'</span> num2str(subSamplingFactor)], subSampledConeExcitation);
<span class="keyword">end</span>  <span class="comment">% subSamplingFactor</span>

maxAllExcitations = max(excitations(:));
excitations = 100.0*excitations/maxAllExcitations;
deltas      = 100.0*deltas/maxAllExcitations;

hFig = figure(100);
set(hFig, <span class="string">'Position'</span>, [100 100 1300 1330]);
clf;

subplotPosVectors = NicePlot.getSubPlotPosVectors(<span class="keyword">...</span>
    <span class="string">'rowsNum'</span>,      numel(coneTypes), <span class="keyword">...</span>
    <span class="string">'colsNum'</span>,      numel(primaries), <span class="keyword">...</span>
    <span class="string">'widthMargin'</span>,  0.03, <span class="keyword">...</span>
    <span class="string">'heightMargin'</span>, 0.06, <span class="keyword">...</span>
    <span class="string">'leftMargin'</span>,   0.04, <span class="keyword">...</span>
    <span class="string">'bottomMargin'</span>, 0.03, <span class="keyword">...</span>
    <span class="string">'topMargin'</span>,    0.01);

<span class="keyword">for</span> cone = 1:numel(coneTypes)
    <span class="keyword">for</span> channel = 1:numel(primaries)
        subplot(<span class="string">'Position'</span>, subplotPosVectors(cone,channel).v);

        subSPD  = squeeze(deltas(:,cone,channel));
        origSPD = squeeze(excitations(:,cone,channel));
        hold <span class="string">on</span>;
        plot(subSamplingFactorsTested, origSPD, <span class="string">'k-'</span>, <span class="string">'LineWidth'</span>, 2.0);
        errors = 100.0*((subSPD-origSPD)./origSPD);
        <span class="keyword">if</span> (abs(max(errors)) &gt; abs(min(errors)))
            dist = 0.7;
        <span class="keyword">else</span>
            dist = -0.7;
        <span class="keyword">end</span>
        <span class="keyword">for</span> k = 1:numel(subSamplingFactorsTested)
            x = subSamplingFactorsTested(k);
            y = subSPD(k)+dist*k;
            plot([x x], [subSPD(k) y], <span class="string">'r-'</span>);
            text(x-0.7,y+dist/5,sprintf(<span class="string">'%3.1f%%'</span>, abs(errors(k))), <span class="string">'Color'</span>, <span class="string">'k'</span>, <span class="string">'FontSize'</span>, 11, <span class="string">'EdgeColor'</span>, <span class="string">'r'</span>, <span class="string">'BackgroundColor'</span>, [1 1 1]);
        <span class="keyword">end</span>
        plot(subSamplingFactorsTested, subSPD, <span class="string">'rs-'</span>, <span class="string">'MarkerFaceColor'</span>, [1.0 0.8 0.8], <span class="string">'MarkerSize'</span>, 12, <span class="string">'LineWidth'</span>, 2);
        hold <span class="string">off</span>
        h_legend=legend(<span class="string">'original SPD'</span>, <span class="string">'subsampled SPD'</span>);
        set(h_legend, <span class="string">'Location'</span>, <span class="string">'northwest'</span>);
        yTicks = [-50:2:120];
        xTicks = subSamplingFactorsTested;
        minSPD = min([min(origSPD(:)) min(subSPD(:))]);
        maxSPD = max([max(origSPD(:)) max(subSPD(:))]);
        offset = 30 - (maxSPD-minSPD);
        YLims = [minSPD-offset/2 maxSPD+offset/2];
        set(gca, <span class="string">'XLim'</span>, [subSamplingFactorsTested(1)-1 subSamplingFactorsTested(end)+1], <span class="string">'YLim'</span>, YLims, <span class="string">'YTick'</span>, yTicks, <span class="string">'YTickLabel'</span>, yTicks, <span class="string">'XTick'</span>, xTicks, <span class="string">'XTickLabel'</span>, xTicks);
        xlabel(<span class="string">'subsampling factor'</span>); <span class="comment">% , 'FontWeight', 'bold', 'FontSize', 14);</span>
        <span class="keyword">if</span> (channel == 1)
            ylabel(<span class="string">'normalized cone excitation'</span>); <span class="comment">% , 'FontWeight', 'bold', 'FontSize', 14);</span>
        <span class="keyword">end</span>
        title(sprintf(<span class="string">'%s cone , %s primary'</span>, coneTypes{cone}, primaries{channel})); <span class="comment">% , 'FontWeight', 'bold', 'FontSize', 18);</span>
        box <span class="string">on</span>
        grid <span class="string">on</span>
        UnitTest.validationData(sprintf(<span class="string">'%scone%sprimary'</span>, coneTypes{cone}, primaries{channel}), subSPD);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% Set fonts for all axes, legends, and titles</span>
NicePlot.setFontSizes(hFig, <span class="string">'FontSize'</span>, 12);
<span class="keyword">end</span>

<span class="comment">% Method to generate a Gaussian LowPass kernel</span>
<span class="keyword">function</span> gaussF = generateGaussianLowPassKernel(subSamplingFactor, sigma, samplingAxis, maintainTotalEnergy)

samplingAxis = (0:(numel(samplingAxis)-1))-(numel(samplingAxis)/2)+0.5;

<span class="keyword">if</span> (subSamplingFactor &lt;= 1)
    gaussF = zeros(size(samplingAxis));
    gaussF(samplingAxis == 0) = 1;
<span class="keyword">else</span>
    gaussF = exp(-0.5*(samplingAxis/sigma).^2);
    <span class="keyword">if</span> (maintainTotalEnergy)
        gain = subSamplingFactor;
    <span class="keyword">else</span>
        gain = 1;
    <span class="keyword">end</span>
    gaussF = gain * gaussF / sum(gaussF);
<span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> calStructOBJ = loadCalibrationData(calFile)
dir = fileparts(mfilename(<span class="string">'fullpath'</span>));
<span class="comment">% Load the calibration data</span>
cal = LoadCalFile(calFile, [], dir);
<span class="comment">% generate calStructOBJ to access the calibration data</span>
calStructOBJ = ObjectToHandleCalOrCalStruct(cal);
clear <span class="string">'cal'</span>
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="v_SPDSubsampling_01.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_02.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_03.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_04.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_05.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_06.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_07.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_08.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_09.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_10.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_11.png" alt=""> <img vspace="5" hspace="5" src="v_SPDSubsampling_12.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015a</a><br></p></div><!--
##### SOURCE BEGIN #####
function varargout = v_SPDSubsampling(varargin)
%
% This function will validate the effects of subsampling the SPD's of the
% display.
%
% 7/30/15  xd  modified from Nicolas's original code to make a validation
%              script

varargout = UnitTest.runValidationRun(@ValidationFunction, nargout, varargin);
end

%% Function implementing the isetbio validation code
function ValidationFunction(runTimeParams)
% close all figures
close all

% Load the imageData and generate the calibrationData object
calStructOBJ = loadCalibrationData('StereoLCDBLIllumDiscrim');
calStructOBJ.cal.describe;

% Retrieve the display primaries SPD data from the calibration
wavelengthSampling = SToWls(calStructOBJ.get('S'));
originalSPDs = calStructOBJ.get('P_device');

primaries = {'RED', 'GREEN', 'BLUE'};
coneTypes = {'L', 'M', 'S'};

% Analysis parameters
% set this to false to visualize primary SPDs on same scale
% set this to true to maintain total power constant
maintainTotalEnergy = true;

% size of FFT
FFTsize = 1024;

% SPD subsampling factors to examine (1==original SPD)
subSamplingFactorsTested = [1 2 4 6 8 10 12 14 16 18 20];

for subSamplingFactorIndex = 1:numel(subSamplingFactorsTested)
    
    subSamplingFactor = subSamplingFactorsTested(subSamplingFactorIndex);
    subSamplingVector = (1:subSamplingFactor:numel(wavelengthSampling));
    subSampledWavelengthSampling = wavelengthSampling(subSamplingVector);
    
    % set the sigma of the gaussian kernel according to subSamplingFactor
    sigma = subSamplingFactor/2;
    % generate lowpass kernel
    kernelF = generateGaussianLowPassKernel(subSamplingFactor, sigma, wavelengthSampling, maintainTotalEnergy);
    
    % zero pad kernel to increase spectral resolution
    ix = floor(numel(kernelF)/2);
    paddedKernelF = zeros(1,FFTsize);
    paddedKernelF(FFTsize/2+(-ix:ix)) = kernelF;
    
    lowpassedSPD = zeros(numel(wavelengthSampling), numel(primaries));
    subsampledSPD = zeros(numel(subSamplingVector), numel(primaries));
    
    for primaryIndex = 1:numel(primaries)
        % zero pad SPD to increase spectral resolution
        paddedSPD = zeros(1,FFTsize);
        paddedSPD(FFTsize/2+(-ix:ix)) = squeeze(originalSPDs(:,primaryIndex));
        
        % filter SPD with kernel in frequency domain
        FFTkernel = fft(paddedKernelF);
        FFTspd    = fft(paddedSPD);
        tmp       = FFTspd .* FFTkernel;
        
        % back in original domain
        tmp = ifftshift(ifft(tmp));
        lowpassedSPD(:,primaryIndex)  = tmp(FFTsize/2-1+(-ix:ix));
        
        % subsampled the lowpassed SPD
        subsampledSPD(:,primaryIndex) = lowpassedSPD(subSamplingVector,primaryIndex);
    end
    
    originalSPDpower   = sum(originalSPDs,1);
    subSampledSPDpower = sum(subsampledSPD,1);
    
    
    hFig = figure(subSamplingFactor);
    set(hFig, 'Position', [200 200 1731 1064]);
    clf;
    
    maxY = max([max(subsampledSPD(:)) max(originalSPDs(:)) max(lowpassedSPD(:))]);
    
    % plot SPDs (original, lowpassed, and subsampled as well as the smoothing kernel)
    for primaryIndex = 1:numel(primaries)
        subplot(3, 7, [1 2 3 4 5 6]+(primaryIndex-1)*7);
        hold on;
        plot(subSampledWavelengthSampling, subsampledSPD(:,primaryIndex), 'ro-', 'MarkerFaceColor', [1.0 0.7 0.7], 'MarkerSize', 14);
        plot(wavelengthSampling, lowpassedSPD(:, primaryIndex), 'ks:', 'MarkerFaceColor', [0.8 0.8 0.8], 'MarkerSize', 8);
        plot(wavelengthSampling, originalSPDs(:, primaryIndex), 'ks-', 'MarkerFaceColor', [0.1 0.1 0.1], 'MarkerSize', 6);
        hStem = stem(wavelengthSampling, maxY/2 + kernelF*maxY/3, 'Color', [0.5 0.5 0.90], 'LineWidth', 1, 'MarkerFaceColor', [0.7 0.7 0.9]);
        hStem.BaseValue = maxY/2;
        hold off;
        set(gca, 'YLim', [0 maxY], 'XLim', [min(wavelengthSampling) max(wavelengthSampling)]);
        h_legend=legend('subsampled SPD', 'lowpassedSPD', 'originalSPD', 'lowpass kernel');
        box on;
        xlabel('wavelength (nm)'); ylabel('energy');
        title(sprintf('%s PRIMARY power = %2.4f (original SPD) vs. %2.4f (subsampled SPD)', primaries{primaryIndex}, originalSPDpower(primaryIndex), subSampledSPDpower(primaryIndex)));
    end
    
    % Load cone spectra and interpolate to desired wavelength sampling
    load('T_cones_ss2.mat');
    originalSpectralSensitivityFunctions       = SplineCmf(S_cones_ss2, T_cones_ss2, WlsToS(wavelengthSampling));
    subSampledConeSpectralSensitivityFunctions = SplineCmf(S_cones_ss2, T_cones_ss2, WlsToS(subSampledWavelengthSampling));
    
    % Compute cone activations
    originalConeExcitation = zeros(3,3);
    subSampledConeExcitation = zeros(3,3);
    for cone = 1:3
        for primaryIndex = 1:3
            originalConeExcitation(cone, primaryIndex) = sum(originalSpectralSensitivityFunctions(cone,:) .* (originalSPDs(:, primaryIndex))');
            subSampledConeExcitation(cone, primaryIndex) = sum(subSampledConeSpectralSensitivityFunctions(cone,:) .* (subsampledSPD(:, primaryIndex))');
        end
    end
    
    % Plot cone activations
    figure(subSamplingFactor);
    for primaryIndex = 1:numel(primaries)
        subplot(3, 7, 7+(primaryIndex-1)*7);
        bar([1:3], originalConeExcitation(:,primaryIndex), 'EdgeColor', [0 0 0], 'FaceColor', [0.5 0.5 0.5]);
        hold on;
        bar([1:3], -subSampledConeExcitation(:,primaryIndex), 'EdgeColor', [1 0 0], 'FaceColor', [1.0 0.8 0.8]);
        bar([1:3], originalConeExcitation(:,primaryIndex)-subSampledConeExcitation(:,primaryIndex), 'EdgeColor', [0 1 0], 'FaceColor', [0.1 0.9 0.1]);
        hold off;
        h_legend=legend('original', 'subsampled', 'residual');
        xlabel('cone type'); ylabel('cone excitation');
        set(gca, 'XTick', [1 2 3], 'XTickLabel', coneTypes);
        title(sprintf('%s primary', primaries{primaryIndex}));
    end
    
    deltas(subSamplingFactorIndex,:,:)       = subSampledConeExcitation;
    excitations(subSamplingFactorIndex, :,:) = originalConeExcitation;
    
    suplabel(['Subsample Factor: ' num2str(subSamplingFactor)], 't');
    
    % Set fonts for all axes, legends, and titles
    NicePlot.setFontSizes(hFig, 'FontSize', 12);
    UnitTest.validationData(['subsamplefactor' num2str(subSamplingFactor)], subSampledConeExcitation);
end  % subSamplingFactor

maxAllExcitations = max(excitations(:));
excitations = 100.0*excitations/maxAllExcitations;
deltas      = 100.0*deltas/maxAllExcitations;

hFig = figure(100);
set(hFig, 'Position', [100 100 1300 1330]);
clf;

subplotPosVectors = NicePlot.getSubPlotPosVectors(...
    'rowsNum',      numel(coneTypes), ...
    'colsNum',      numel(primaries), ...
    'widthMargin',  0.03, ...
    'heightMargin', 0.06, ...
    'leftMargin',   0.04, ...
    'bottomMargin', 0.03, ...
    'topMargin',    0.01);

for cone = 1:numel(coneTypes)
    for channel = 1:numel(primaries)
        subplot('Position', subplotPosVectors(cone,channel).v);
        
        subSPD  = squeeze(deltas(:,cone,channel));
        origSPD = squeeze(excitations(:,cone,channel));
        hold on;
        plot(subSamplingFactorsTested, origSPD, 'k-', 'LineWidth', 2.0);
        errors = 100.0*((subSPD-origSPD)./origSPD);
        if (abs(max(errors)) > abs(min(errors)))
            dist = 0.7;
        else
            dist = -0.7;
        end
        for k = 1:numel(subSamplingFactorsTested)
            x = subSamplingFactorsTested(k);
            y = subSPD(k)+dist*k;
            plot([x x], [subSPD(k) y], 'r-');
            text(x-0.7,y+dist/5,sprintf('%3.1f%%', abs(errors(k))), 'Color', 'k', 'FontSize', 11, 'EdgeColor', 'r', 'BackgroundColor', [1 1 1]);
        end
        plot(subSamplingFactorsTested, subSPD, 'rs-', 'MarkerFaceColor', [1.0 0.8 0.8], 'MarkerSize', 12, 'LineWidth', 2);
        hold off
        h_legend=legend('original SPD', 'subsampled SPD');
        set(h_legend, 'Location', 'northwest');
        yTicks = [-50:2:120];
        xTicks = subSamplingFactorsTested;
        minSPD = min([min(origSPD(:)) min(subSPD(:))]);
        maxSPD = max([max(origSPD(:)) max(subSPD(:))]);
        offset = 30 - (maxSPD-minSPD);
        YLims = [minSPD-offset/2 maxSPD+offset/2];
        set(gca, 'XLim', [subSamplingFactorsTested(1)-1 subSamplingFactorsTested(end)+1], 'YLim', YLims, 'YTick', yTicks, 'YTickLabel', yTicks, 'XTick', xTicks, 'XTickLabel', xTicks);
        xlabel('subsampling factor'); % , 'FontWeight', 'bold', 'FontSize', 14);
        if (channel == 1)
            ylabel('normalized cone excitation'); % , 'FontWeight', 'bold', 'FontSize', 14);
        end
        title(sprintf('%s cone , %s primary', coneTypes{cone}, primaries{channel})); % , 'FontWeight', 'bold', 'FontSize', 18);
        box on
        grid on
        UnitTest.validationData(sprintf('%scone%sprimary', coneTypes{cone}, primaries{channel}), subSPD); 
    end
end

% Set fonts for all axes, legends, and titles
NicePlot.setFontSizes(hFig, 'FontSize', 12);
end

% Method to generate a Gaussian LowPass kernel
function gaussF = generateGaussianLowPassKernel(subSamplingFactor, sigma, samplingAxis, maintainTotalEnergy)

samplingAxis = (0:(numel(samplingAxis)-1))-(numel(samplingAxis)/2)+0.5;

if (subSamplingFactor <= 1)
    gaussF = zeros(size(samplingAxis));
    gaussF(samplingAxis == 0) = 1;
else
    gaussF = exp(-0.5*(samplingAxis/sigma).^2);
    if (maintainTotalEnergy)
        gain = subSamplingFactor;
    else
        gain = 1;
    end
    gaussF = gain * gaussF / sum(gaussF);
end
end

function calStructOBJ = loadCalibrationData(calFile)
dir = fileparts(mfilename('fullpath'));
% Load the calibration data
cal = LoadCalFile(calFile, [], dir);
% generate calStructOBJ to access the calibration data
calStructOBJ = ObjectToHandleCalOrCalStruct(cal);
clear 'cal'
end
##### SOURCE END #####
--></body></html>